<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Trials and Tribulations of Analyzing TikTok Comment Data :: Terminal</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Let&#39;s analyze TikTok comment data for a given user and find that user&#39;s biggest critics and detractors." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://ib173.github.io/posts/tiktokanalysis/" />




<link rel="stylesheet" href="https://ib173.github.io/assets/style.css">

  <link rel="stylesheet" href="https://ib173.github.io/assets/pink.css">






<link rel="apple-touch-icon" href="https://ib173.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://ib173.github.io/img/favicon/pink.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="Ian Brown" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Trials and Tribulations of Analyzing TikTok Comment Data">
<meta property="og:description" content="Let&#39;s analyze TikTok comment data for a given user and find that user&#39;s biggest critics and detractors." />
<meta property="og:url" content="https://ib173.github.io/posts/tiktokanalysis/" />
<meta property="og:site_name" content="Terminal" />

  <meta property="og:image" content="https://ib173.github.io/hello.png">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-09-22 00:00:00 &#43;0000 UTC" />












</head>
<body class="pink">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Ian Brown
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://ib173.github.io/posts/tiktokanalysis/">Trials and Tribulations of Analyzing TikTok Comment Data</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-09-22
        
      </span>
    
    
      <span class="post-author">:: Ian Brown</span>
    
    
  </div>

  
  
  <img src="https://ib173.github.io/hello.png"
    class="post-cover"
    alt="Trials and Tribulations of Analyzing TikTok Comment Data"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <h1 id="the-project">The Project<a href="#the-project" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>For this project, we want to be able to look at a given TikTok user and analyze their comments. In particular, we want to find a way surmise the biggest fans and critics of the given account.</p>
<h1 id="mining-comment-data">Mining Comment Data<a href="#mining-comment-data" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Searching GitHub, I came across this project. A simple, albeit hacky means of pulling comment data. Comments are generated and &ldquo;yielded&rdquo; by the program. Let&rsquo;s abstract this code out to act as a service scraper, collecting and returning comments rather than yielding them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pprint <span style="color:#f92672">import</span> pprint
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, Iterator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.service.utils <span style="color:#f92672">import</span> extract_tiktok_id_from_url
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TikTokCommentsScraper</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, tiktok_id: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tiktok_id <span style="color:#f92672">=</span> tiktok_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>comments_api_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://www.tiktok.com/api/comment/list/&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_cursor <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>comments_per_request <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>replies_per_request <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;User-Agent&#39;</span>: <span style="color:#e6db74">&#39;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:100.0) Gecko/20100101 Firefox/100.0&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Accept&#39;</span>: <span style="color:#e6db74">&#39;*/*&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Accept-Language&#39;</span>: <span style="color:#e6db74">&#39;fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Referer&#39;</span>: <span style="color:#e6db74">&#34;https://www.tiktok.com/&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Connection&#39;</span>: <span style="color:#e6db74">&#39;keep-alive&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Sec-Fetch-Dest&#39;</span>: <span style="color:#e6db74">&#39;empty&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Sec-Fetch-Mode&#39;</span>: <span style="color:#e6db74">&#39;cors&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Sec-Fetch-Site&#39;</span>: <span style="color:#e6db74">&#39;same-origin&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Pragma&#39;</span>: <span style="color:#e6db74">&#39;no-cache&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;Cache-Control&#39;</span>: <span style="color:#e6db74">&#39;no-cache&#39;</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;aid&#39;</span>: <span style="color:#e6db74">&#39;1988&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;app_language&#39;</span>: <span style="color:#e6db74">&#39;ja-JP&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;app_name&#39;</span>: <span style="color:#e6db74">&#39;tiktok_web&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;aweme_id&#39;</span>: self<span style="color:#f92672">.</span>tiktok_id,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;browser_language&#39;</span>: <span style="color:#e6db74">&#39;en&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;browser_name&#39;</span>: <span style="color:#e6db74">&#39;Mozilla&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;browser_online&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;browser_platform&#39;</span>: <span style="color:#e6db74">&#39;Linux x86_64&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;browser_version&#39;</span>: <span style="color:#e6db74">&#39;5.0 (X11)&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;channel&#39;</span>: <span style="color:#e6db74">&#39;tiktok_web&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;cookie_enabled&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;count&#39;</span>: self<span style="color:#f92672">.</span>comments_per_request,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;current_region&#39;</span>: <span style="color:#e6db74">&#39;JP&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;cursor&#39;</span>: str(self<span style="color:#f92672">.</span>_cursor),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;device_platform&#39;</span>: <span style="color:#e6db74">&#39;web_pc&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;focus_state&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;fromWeb&#39;</span>: <span style="color:#e6db74">&#39;1&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;from_page&#39;</span>: <span style="color:#e6db74">&#39;video&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;history_len&#39;</span>: <span style="color:#e6db74">&#39;4&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;is_fullscreen&#39;</span>: <span style="color:#e6db74">&#39;false&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;is_page_visible&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;os&#39;</span>: <span style="color:#e6db74">&#39;linux&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;priority_region&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;referer&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;region&#39;</span>: <span style="color:#e6db74">&#39;US&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;screen_height&#39;</span>: <span style="color:#e6db74">&#39;1080&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;screen_width&#39;</span>: <span style="color:#e6db74">&#39;1920&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;tz_name&#39;</span>: <span style="color:#e6db74">&#39;America/New_York&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;webcast_language&#39;</span>: <span style="color:#e6db74">&#39;en&#39;</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">from_url</span>(cls, tiktok_url: str) <span style="color:#f92672">-&gt;</span> TikTokCommentsScraper:
</span></span><span style="display:flex;"><span>        tiktok_id <span style="color:#f92672">=</span> extract_tiktok_id_from_url(tiktok_url)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cls(tiktok_id)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_replies_from_comment</span>(self, comment: Dict) <span style="color:#f92672">-&gt;</span> Iterator[Dict[str, str,]]:
</span></span><span style="display:flex;"><span>        cursor <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        all_comments <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> comment[<span style="color:#e6db74">&#34;reply_comment_total&#34;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            comment_id <span style="color:#f92672">=</span> comment[<span style="color:#e6db74">&#34;cid&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            has_replies <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> has_replies:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Generate new params</span>
</span></span><span style="display:flex;"><span>                _params <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>params<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>                _params[<span style="color:#e6db74">&#34;cursor&#34;</span>] <span style="color:#f92672">=</span> str(cursor)
</span></span><span style="display:flex;"><span>                _params[<span style="color:#e6db74">&#34;count&#34;</span>] <span style="color:#f92672">=</span> str(self<span style="color:#f92672">.</span>replies_per_request)
</span></span><span style="display:flex;"><span>                _params[<span style="color:#e6db74">&#34;comment_id&#34;</span>] <span style="color:#f92672">=</span> comment_id
</span></span><span style="display:flex;"><span>                _params[<span style="color:#e6db74">&#34;item_id&#34;</span>] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tiktok_id
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">del</span> _params[<span style="color:#e6db74">&#34;aweme_id&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;https://www.tiktok.com/api/comment/list/reply/&#34;</span>,
</span></span><span style="display:flex;"><span>                                        headers<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>headers,
</span></span><span style="display:flex;"><span>                                        params<span style="color:#f92672">=</span>_params)
</span></span><span style="display:flex;"><span>                response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>                comments <span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;comments&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> comments <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                    all_comments<span style="color:#f92672">.</span>append(comments)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> data[<span style="color:#e6db74">&#34;has_more&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                    cursor <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>replies_per_request
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    has_replies <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> all_comments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_extract_essentials_from_comment</span>(self, comment: Dict) <span style="color:#f92672">-&gt;</span> Dict[str, str]:
</span></span><span style="display:flex;"><span>        comment_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        comment_dict[<span style="color:#e6db74">&#34;comment_id&#34;</span>] <span style="color:#f92672">=</span> comment[<span style="color:#e6db74">&#34;cid&#34;</span>]
</span></span><span style="display:flex;"><span>        comment_dict[<span style="color:#e6db74">&#34;text&#34;</span>] <span style="color:#f92672">=</span> comment[<span style="color:#e6db74">&#34;text&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># comment_dict[&#34;create_time&#34;] = datetime.datetime.fromtimestamp(comment[&#34;create_time&#34;])</span>
</span></span><span style="display:flex;"><span>        comment_dict[<span style="color:#e6db74">&#34;create_time&#34;</span>] <span style="color:#f92672">=</span> comment[<span style="color:#e6db74">&#34;create_time&#34;</span>]
</span></span><span style="display:flex;"><span>        comment_dict[<span style="color:#e6db74">&#34;user_nickname&#34;</span>] <span style="color:#f92672">=</span> comment[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;nickname&#34;</span>]
</span></span><span style="display:flex;"><span>        comment_dict[<span style="color:#e6db74">&#34;comment_language&#34;</span>] <span style="color:#f92672">=</span> comment[<span style="color:#e6db74">&#34;comment_language&#34;</span>]
</span></span><span style="display:flex;"><span>        comment_dict[<span style="color:#e6db74">&#34;likes&#34;</span>] <span style="color:#f92672">=</span> comment[<span style="color:#e6db74">&#34;digg_count&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> comment_dict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
</span></span><span style="display:flex;"><span>        has_more_comments <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        all_comments <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        comments_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> has_more_comments:
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(self<span style="color:#f92672">.</span>comments_api_url,
</span></span><span style="display:flex;"><span>                                    params<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>params,
</span></span><span style="display:flex;"><span>                                    headers<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>headers)
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>            base_comments <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;comments&#34;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> comment <span style="color:#f92672">in</span> base_comments:
</span></span><span style="display:flex;"><span>                    base_comment <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_extract_essentials_from_comment(comment)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    temp_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>                    temp_dict[<span style="color:#e6db74">&#39;base_comment&#39;</span>] <span style="color:#f92672">=</span> base_comment
</span></span><span style="display:flex;"><span>                    replies <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>generate_replies_from_comment(comment)
</span></span><span style="display:flex;"><span>                    temp_dict[<span style="color:#e6db74">&#39;replies&#39;</span>] <span style="color:#f92672">=</span> replies
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># print(base_comment)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># print(type(base_comment))</span>
</span></span><span style="display:flex;"><span>                    all_comments[base_comment[<span style="color:#e6db74">&#39;comment_id&#39;</span>]] <span style="color:#f92672">=</span> temp_dict
</span></span><span style="display:flex;"><span>                    comments_list<span style="color:#f92672">.</span>append(temp_dict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> data[<span style="color:#e6db74">&#34;has_more&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                    has_more_comments <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                    cursor <span style="color:#f92672">=</span> int(self<span style="color:#f92672">.</span>params[<span style="color:#e6db74">&#34;cursor&#34;</span>])
</span></span><span style="display:flex;"><span>                    cursor <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>comments_per_request
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>params[<span style="color:#e6db74">&#34;cursor&#34;</span>] <span style="color:#f92672">=</span> str(cursor)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    has_more_comments <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> comments_list
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(f&#39;all comments {all_comments}&#39;)</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;type all comments: </span><span style="color:#e6db74">{</span>type(all_comments)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        print(next(iter(all_comments)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> comments_list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">service_scrape</span>(account, video_id):
</span></span><span style="display:flex;"><span>    screen_width, _ <span style="color:#f92672">=</span> shutil<span style="color:#f92672">.</span>get_terminal_size()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Alternative &#34;constructor&#34;</span>
</span></span><span style="display:flex;"><span>    comments_scraper <span style="color:#f92672">=</span> TikTokCommentsScraper<span style="color:#f92672">.</span>from_url(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;https://www.tiktok.com/@</span><span style="color:#e6db74">{</span>account<span style="color:#e6db74">}</span><span style="color:#e6db74">/video/</span><span style="color:#e6db74">{</span>video_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    comments <span style="color:#f92672">=</span> comments_scraper<span style="color:#f92672">.</span>run()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;just grabbed </span><span style="color:#e6db74">{</span>len(comments)<span style="color:#e6db74">}</span><span style="color:#e6db74"> comments.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> comments
</span></span></code></pre></div><p>Now we have an application that, given a TikTok account and video_id, can return a bulk comment object containing comments and nested replies to those comments.</p>
<h1 id="mining-video-data">Mining Video Data<a href="#mining-video-data" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>For mining video data, let&rsquo;s leverage this project and make some alterations to fit our needs. We already have a means to pull comments given an account and video id, so let&rsquo;s combine these two applications to save work.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> collections
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> playwright.sync_api <span style="color:#f92672">import</span> Page
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> playwright.sync_api <span style="color:#f92672">import</span> Response
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> playwright.sync_api <span style="color:#f92672">import</span> Route
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> playwright.sync_api <span style="color:#f92672">import</span> sync_playwright
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.constants <span style="color:#f92672">import</span> constants
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.service <span style="color:#f92672">import</span> utils
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.service.scrape <span style="color:#f92672">import</span> scrape_comments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TikTokScraper</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, account: str, path: str, headless: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>account <span style="color:#f92672">=</span> account
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_videos_urls <span style="color:#f92672">=</span> set()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_headless <span style="color:#f92672">=</span> headless
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_base_video_folder_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>account<span style="color:#e6db74">}</span><span style="color:#e6db74">downloaded_videos&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_full_path_directory <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(path, self<span style="color:#f92672">.</span>_base_video_folder_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_create_downloaded_videos_directory_if_not_exists()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_generate_tiktok_url</span>(self, lang: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;en&#34;</span>) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;https://www.tiktok.com/@</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>account<span style="color:#e6db74">}</span><span style="color:#e6db74">?lang=</span><span style="color:#e6db74">{</span>lang<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_create_downloaded_videos_directory_if_not_exists</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(self<span style="color:#f92672">.</span>_full_path_directory):
</span></span><span style="display:flex;"><span>            os<span style="color:#f92672">.</span>makedirs(self<span style="color:#f92672">.</span>_full_path_directory)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_extract_video_download_addr_from_item</span>(self, item: Dict) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_extract_description_from_tiktok_item(item)
</span></span><span style="display:flex;"><span>        download_video_url <span style="color:#f92672">=</span> item[<span style="color:#e6db74">&#34;video&#34;</span>][<span style="color:#e6db74">&#34;downloadAddr&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> download_video_url <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_videos_urls:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_videos_urls<span style="color:#f92672">.</span>add(download_video_url)
</span></span><span style="display:flex;"><span>            utils<span style="color:#f92672">.</span>download_video_background(download_video_url, self<span style="color:#f92672">.</span>_full_path_directory)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_extract_description_from_tiktok_item</span>(self, item: Dict) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        tiktok_id <span style="color:#f92672">=</span> item[<span style="color:#e6db74">&#34;id&#34;</span>]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Tiktok ID:&#34;</span>, tiktok_id)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(item)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_xhr_request</span>(self, response: Response) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>url<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;https://m.tiktok.com/api/post/item_list/&#34;</span>):
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>                items <span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;itemList&#34;</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> items:
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>_extract_video_download_addr_from_item(item)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;No xhr data here...&#34;</span>, e)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_comments</span>(self, response: Response) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;fetching comments&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>account, <span style="color:#e6db74">&#39;video_corpus.csv&#39;</span>)):
</span></span><span style="display:flex;"><span>                current_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>account, <span style="color:#e6db74">&#39;video_corpus.csv&#39;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>resource_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;document&#34;</span>:
</span></span><span style="display:flex;"><span>                content <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>text()
</span></span><span style="display:flex;"><span>                soup <span style="color:#f92672">=</span> BeautifulSoup(content, <span style="color:#e6db74">&#34;html.parser&#34;</span>)
</span></span><span style="display:flex;"><span>                json_data <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>select_one(constants<span style="color:#f92672">.</span>DOCUMENT_JSON_SCRIPT_CSS_SELECTOR)<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(json_data)
</span></span><span style="display:flex;"><span>                raw_data <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> key, item <span style="color:#f92672">in</span> data[<span style="color:#e6db74">&#34;ItemModule&#34;</span>]<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># if int(key) not in list(current_df[&#39;id&#39;]):</span>
</span></span><span style="display:flex;"><span>                        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;grabbing comments for item </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                        comments <span style="color:#f92672">=</span> scrape_comments<span style="color:#f92672">.</span>service_scrape(self<span style="color:#f92672">.</span>account, item[<span style="color:#e6db74">&#39;id&#39;</span>])
</span></span><span style="display:flex;"><span>                        item[<span style="color:#e6db74">&#39;replies&#39;</span>] <span style="color:#f92672">=</span> comments
</span></span><span style="display:flex;"><span>                        print(<span style="color:#e6db74">&#39;type::&#39;</span>)
</span></span><span style="display:flex;"><span>                        print(type(comments))
</span></span><span style="display:flex;"><span>                        raw_data<span style="color:#f92672">.</span>append(item)
</span></span><span style="display:flex;"><span>                        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;grabbed comments for item </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># else:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">#     print(&#39;item comments have already been collected&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;fetched </span><span style="color:#e6db74">{</span>len(comments)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#39;done fetching videos and comments... creating corpus&#39;</span>)
</span></span><span style="display:flex;"><span>                df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(raw_data)
</span></span><span style="display:flex;"><span>                df<span style="color:#f92672">.</span>to_csv(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>account, <span style="color:#e6db74">&#39;video_corpus.csv&#39;</span>), index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;done fetching comments&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;No document data here...&#34;</span>, e)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_document_request</span>(self, response: Response) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;fetching videos&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>resource_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;document&#34;</span>:
</span></span><span style="display:flex;"><span>                content <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>text()
</span></span><span style="display:flex;"><span>                soup <span style="color:#f92672">=</span> BeautifulSoup(content, <span style="color:#e6db74">&#34;html.parser&#34;</span>)
</span></span><span style="display:flex;"><span>                json_data <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>select_one(constants<span style="color:#f92672">.</span>DOCUMENT_JSON_SCRIPT_CSS_SELECTOR)<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(json_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> key, item <span style="color:#f92672">in</span> data[<span style="color:#e6db74">&#34;ItemModule&#34;</span>]<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                        self<span style="color:#f92672">.</span>_extract_video_download_addr_from_item(item)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>                        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;failed to download video: </span><span style="color:#e6db74">{</span>item[<span style="color:#e6db74">&#34;id&#34;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;done fetching videos&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;No document data here...&#34;</span>, e)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">block_unnecessary_resources</span>(self, route: Route) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (route<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>resource_type <span style="color:#f92672">in</span> constants<span style="color:#f92672">.</span>EXCLUDED_RESOURCE_TYPES):
</span></span><span style="display:flex;"><span>            route<span style="color:#f92672">.</span>abort()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> route<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>url <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;https://mon-va.byteoversea.com/monitor_browser/collect/batch/&#34;</span>:
</span></span><span style="display:flex;"><span>            route<span style="color:#f92672">.</span>abort()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            route<span style="color:#f92672">.</span>continue_()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_has_bot_reached_bottom_of_the_page</span>(self, page: Page) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> page<span style="color:#f92672">.</span>evaluate(constants<span style="color:#f92672">.</span>JAVASCRIPT_BOTTOM_PAGE_CHECKER)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_scroll_to_bottom</span>(self, page: Page) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        positions_y_deque_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        last_y_positions <span style="color:#f92672">=</span> collections<span style="color:#f92672">.</span>deque(maxlen<span style="color:#f92672">=</span>positions_y_deque_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        has_reached <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> has_reached:
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>mouse<span style="color:#f92672">.</span>wheel(delta_x<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, delta_y<span style="color:#f92672">=</span><span style="color:#ae81ff">75</span>)
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>wait_for_load_state(<span style="color:#e6db74">&#34;domcontentloaded&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> page<span style="color:#f92672">.</span>evaluate(<span style="color:#e6db74">&#34;window.scrollY&#34;</span>)
</span></span><span style="display:flex;"><span>            last_y_positions<span style="color:#f92672">.</span>append(value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(last_y_positions) <span style="color:#f92672">==</span> positions_y_deque_size <span style="color:#f92672">and</span> len(set(last_y_positions)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                has_reached <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
</span></span><span style="display:flex;"><span>        sync_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> sync_playwright() <span style="color:#66d9ef">as</span> p:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> sync_count <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>                exit
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;syncing playwright&#39;</span>)
</span></span><span style="display:flex;"><span>            browser <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>firefox<span style="color:#f92672">.</span>launch(headless<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>_headless)
</span></span><span style="display:flex;"><span>            context <span style="color:#f92672">=</span> browser<span style="color:#f92672">.</span>new_context(viewport<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;width&#34;</span>: <span style="color:#ae81ff">1920</span>, <span style="color:#e6db74">&#34;height&#34;</span>: <span style="color:#ae81ff">1080</span>})
</span></span><span style="display:flex;"><span>            page <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>new_page()
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;response&#34;</span>, self<span style="color:#f92672">.</span>handle_document_request)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;done fetching videos&#39;</span>)
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;response&#34;</span>, self<span style="color:#f92672">.</span>get_comments)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;done fetching comments&#39;</span>)
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>on(<span style="color:#e6db74">&#34;response&#34;</span>, self<span style="color:#f92672">.</span>handle_xhr_request)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;done with xhr request&#39;</span>)
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#34;**/*&#34;</span>, self<span style="color:#f92672">.</span>block_unnecessary_resources)
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>goto(self<span style="color:#f92672">.</span>_generate_tiktok_url())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_scroll_to_bottom(page)
</span></span><span style="display:flex;"><span>            page<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>            sync_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>After collecting comments for a given video, a video corpus containing video metadata and comments is created.</p>
<h4 id="calling-this-process">Calling this Process<a href="#calling-this-process" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>To test this process, let&rsquo;s make a new python file and import our scraper. Then let&rsquo;s run the process for a given account.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.service.scrape.comments_util <span style="color:#f92672">import</span> TikTokScraper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:\Users\iannb\PycharmProjects\tiktok_analytics_platform\backend\data&#39;</span>
</span></span><span style="display:flex;"><span>    account <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;washingtonpost&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># scrape videos, comments, and metadata</span>
</span></span><span style="display:flex;"><span>    video_scraper <span style="color:#f92672">=</span> TikTokScraper(account, path)
</span></span><span style="display:flex;"><span>    video_scraper<span style="color:#f92672">.</span>run()
</span></span></code></pre></div><h1 id="building-a-comment-model-the-easy-way">Building a Comment Model the Easy Way<a href="#building-a-comment-model-the-easy-way" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h4 id="the-data-issue">The data issue<a href="#the-data-issue" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>The issue that arises when it comes to building a model for TikTok is a very apparent lack of public data. You can search far and wide and be left with not nearly enough comment data with valid labels. In lieu of creating our own corpus and labelling thousands of items for the sake of what should be an easy project, let&rsquo;s think outside the box. Tweets are another comment medium we can look at, and Twitter has a ton of public data sets.</p>
<h4 id="so-lets-build-a-tweet-classifier">So Let&rsquo;s Build a Tweet Classifier<a href="#so-lets-build-a-tweet-classifier" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>We can use nltk to build ourselves a simple Tweet classifer leveraging naive bayes as our classification technique.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> nltk
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nltk.stem.wordnet <span style="color:#f92672">import</span> WordNetLemmatizer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nltk.corpus <span style="color:#f92672">import</span> twitter_samples, stopwords
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nltk.tag <span style="color:#f92672">import</span> pos_tag
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nltk.tokenize <span style="color:#f92672">import</span> word_tokenize
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nltk <span style="color:#f92672">import</span> FreqDist, classify, NaiveBayesClassifier
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.constants.user <span style="color:#f92672">import</span> User, Users
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re<span style="color:#f92672">,</span> string<span style="color:#f92672">,</span> random
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nltk.download(&#39;twitter_samples&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nltk.download(&#39;stopwords&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nltk.download(&#39;averaged_perceptron_tagger&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nltk.download(&#39;wordnet&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nltk.download(&#39;omw-1.4&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nltk.download(&#39;punkt&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_noise</span>(tweet_tokens, stop_words <span style="color:#f92672">=</span> ()):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cleaned_tokens <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> token, tag <span style="color:#f92672">in</span> pos_tag(tweet_tokens):
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(<span style="color:#e6db74">&#39;http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+#]|[!*\(\),]|&#39;</span>\
</span></span><span style="display:flex;"><span>                       <span style="color:#e6db74">&#39;(?:%[0-9a-fA-F][0-9a-fA-F]))+&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>, token)
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(<span style="color:#e6db74">&#34;(@[A-Za-z0-9_]+)&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>, token)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> tag<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;NN&#34;</span>):
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;n&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> tag<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;VB&#39;</span>):
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;v&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            pos <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        lemmatizer <span style="color:#f92672">=</span> WordNetLemmatizer()
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> lemmatizer<span style="color:#f92672">.</span>lemmatize(token, pos)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(token) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> token <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>punctuation <span style="color:#f92672">and</span> token<span style="color:#f92672">.</span>lower() <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> stop_words:
</span></span><span style="display:flex;"><span>            cleaned_tokens<span style="color:#f92672">.</span>append(token<span style="color:#f92672">.</span>lower())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> cleaned_tokens
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_all_words</span>(cleaned_tokens_list):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tokens <span style="color:#f92672">in</span> cleaned_tokens_list:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> token <span style="color:#f92672">in</span> tokens:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">yield</span> token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_tweets_for_model</span>(cleaned_tokens_list):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tweet_tokens <span style="color:#f92672">in</span> cleaned_tokens_list:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> dict([token, <span style="color:#66d9ef">True</span>] <span style="color:#66d9ef">for</span> token <span style="color:#f92672">in</span> tweet_tokens)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_tweet_classifier</span>():
</span></span><span style="display:flex;"><span>    positive_tweets <span style="color:#f92672">=</span> twitter_samples<span style="color:#f92672">.</span>strings(<span style="color:#e6db74">&#39;positive_tweets.json&#39;</span>)
</span></span><span style="display:flex;"><span>    negative_tweets <span style="color:#f92672">=</span> twitter_samples<span style="color:#f92672">.</span>strings(<span style="color:#e6db74">&#39;negative_tweets.json&#39;</span>)
</span></span><span style="display:flex;"><span>    text <span style="color:#f92672">=</span> twitter_samples<span style="color:#f92672">.</span>strings(<span style="color:#e6db74">&#39;tweets.20150430-223406.json&#39;</span>)
</span></span><span style="display:flex;"><span>    tweet_tokens <span style="color:#f92672">=</span> twitter_samples<span style="color:#f92672">.</span>tokenized(<span style="color:#e6db74">&#39;positive_tweets.json&#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stop_words <span style="color:#f92672">=</span> stopwords<span style="color:#f92672">.</span>words(<span style="color:#e6db74">&#39;english&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    positive_tweet_tokens <span style="color:#f92672">=</span> twitter_samples<span style="color:#f92672">.</span>tokenized(<span style="color:#e6db74">&#39;positive_tweets.json&#39;</span>)
</span></span><span style="display:flex;"><span>    negative_tweet_tokens <span style="color:#f92672">=</span> twitter_samples<span style="color:#f92672">.</span>tokenized(<span style="color:#e6db74">&#39;negative_tweets.json&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    positive_cleaned_tokens_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    negative_cleaned_tokens_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># tokenize model data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tokens <span style="color:#f92672">in</span> positive_tweet_tokens:
</span></span><span style="display:flex;"><span>        positive_cleaned_tokens_list<span style="color:#f92672">.</span>append(remove_noise(tokens, stop_words))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tokens <span style="color:#f92672">in</span> negative_tweet_tokens:
</span></span><span style="display:flex;"><span>        negative_cleaned_tokens_list<span style="color:#f92672">.</span>append(remove_noise(tokens, stop_words))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    all_pos_words <span style="color:#f92672">=</span> get_all_words(positive_cleaned_tokens_list)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    freq_dist_pos <span style="color:#f92672">=</span> FreqDist(all_pos_words)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;freq list&#39;</span>, freq_dist_pos<span style="color:#f92672">.</span>most_common(<span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    positive_tokens_for_model <span style="color:#f92672">=</span> get_tweets_for_model(positive_cleaned_tokens_list)
</span></span><span style="display:flex;"><span>    negative_tokens_for_model <span style="color:#f92672">=</span> get_tweets_for_model(negative_cleaned_tokens_list)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    positive_dataset <span style="color:#f92672">=</span> [(tweet_dict, <span style="color:#e6db74">&#34;Positive&#34;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">for</span> tweet_dict <span style="color:#f92672">in</span> positive_tokens_for_model]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    negative_dataset <span style="color:#f92672">=</span> [(tweet_dict, <span style="color:#e6db74">&#34;Negative&#34;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">for</span> tweet_dict <span style="color:#f92672">in</span> negative_tokens_for_model]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dataset <span style="color:#f92672">=</span> positive_dataset <span style="color:#f92672">+</span> negative_dataset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>shuffle(dataset)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;dataset&#39;</span>, dataset[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">100</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    train_data <span style="color:#f92672">=</span> dataset[:<span style="color:#ae81ff">7000</span>]
</span></span><span style="display:flex;"><span>    test_data <span style="color:#f92672">=</span> dataset[<span style="color:#ae81ff">7000</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># build classifier</span>
</span></span><span style="display:flex;"><span>    classifier <span style="color:#f92672">=</span> NaiveBayesClassifier<span style="color:#f92672">.</span>train(train_data)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Accuracy is:&#34;</span>, classify<span style="color:#f92672">.</span>accuracy(classifier, test_data))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> classifier
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_directory_if_not_exists</span>(path):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(path):
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>makedirs(path)
</span></span></code></pre></div><p>Now we have a classifier that&rsquo;s been trained on a large set of positive and negative Tweets. While it is trained on Tweets, we can feed it any given string within reason and yield a sentiment, meaning TikTok comments are fair game. So let&rsquo;s leverage this classifer and pair it with our video corpus.</p>
<h4 id="lets-build-a-user-store-for-tracking-interactions">Let&rsquo;s Build a User Store for Tracking Interactions<a href="#lets-build-a-user-store-for-tracking-interactions" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>The trick here is everytime we build a user store, we also want to be referencing the current user store, allowing us to update in place if we&rsquo;ve seen a user before. We want out User Store to update the following values:</p>
<ul>
<li>accountID</li>
<li>language</li>
<li>cumulative likes on all comments</li>
<li>positive comments</li>
<li>negative comments</li>
<li>total interactions</li>
</ul>
<p>So we&rsquo;ll want to loop through our video corpus for a given &lsquo;original user&rsquo; (ie. the actual TikTok account we&rsquo;re finding the biggest fans and detractors for), and for every video we&rsquo;ll take a look at the comments and build our user store. For each comment, we&rsquo;ll store the user, collect the sentiment, and increment our values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_user_store</span>(account, path):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    full_path <span style="color:#f92672">=</span> path <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">{</span>account<span style="color:#e6db74">}</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    create_directory_if_not_exists(full_path)
</span></span><span style="display:flex;"><span>    classifier <span style="color:#f92672">=</span> build_tweet_classifier()
</span></span><span style="display:flex;"><span>    print(classifier<span style="color:#f92672">.</span>show_most_informative_features(<span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># load video corpus for comments/user data</span>
</span></span><span style="display:flex;"><span>    corpus_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>full_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/video_corpus.csv&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># load user store in case we&#39;ve seen the users before</span>
</span></span><span style="display:flex;"><span>    userStore_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>full_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/user_store.csv&#39;</span>)
</span></span><span style="display:flex;"><span>    negl, posl, totl <span style="color:#f92672">=</span> [], [], []
</span></span><span style="display:flex;"><span>    current_userStore <span style="color:#f92672">=</span> Users()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># cycle through each row/video in the corpus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> index, row <span style="color:#f92672">in</span> corpus_df<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        neg, pos, total <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        replies <span style="color:#f92672">=</span> list(eval(row[<span style="color:#e6db74">&#39;replies&#39;</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># cycle through each reply to the given video</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> reply <span style="color:#f92672">in</span> replies:
</span></span><span style="display:flex;"><span>            base_comment <span style="color:#f92672">=</span> reply[<span style="color:#e6db74">&#39;base_comment&#39;</span>]
</span></span><span style="display:flex;"><span>            text <span style="color:#f92672">=</span> base_comment[<span style="color:#e6db74">&#39;text&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># check if we&#39;ve seen this user before on ANOTHER video. if so, load past user data</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> base_comment[<span style="color:#e6db74">&#39;user_nickname&#39;</span>] <span style="color:#f92672">in</span> userStore_df[<span style="color:#e6db74">&#39;accountID&#39;</span>]:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#39;we have seen this user before&#39;</span>)
</span></span><span style="display:flex;"><span>                temp_user <span style="color:#f92672">=</span> User(user_row<span style="color:#f92672">=</span>userStore_df<span style="color:#f92672">.</span>loc[userStore_df[<span style="color:#e6db74">&#39;accountID&#39;</span>] <span style="color:#f92672">==</span> base_comment[<span style="color:#e6db74">&#39;user_nickname&#39;</span>]])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> base_comment[<span style="color:#e6db74">&#39;user_nickname&#39;</span>] <span style="color:#f92672">and</span> base_comment[<span style="color:#e6db74">&#39;comment_language&#39;</span>]:
</span></span><span style="display:flex;"><span>                    temp_user <span style="color:#f92672">=</span> User(account<span style="color:#f92672">=</span>base_comment[<span style="color:#e6db74">&#39;user_nickname&#39;</span>], lang<span style="color:#f92672">=</span>base_comment[<span style="color:#e6db74">&#39;comment_language&#39;</span>])
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            temp_user<span style="color:#f92672">.</span>add_likes(base_comment[<span style="color:#e6db74">&#39;likes&#39;</span>])
</span></span><span style="display:flex;"><span>            temp_user<span style="color:#f92672">.</span>add_interaction()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># clean up reply</span>
</span></span><span style="display:flex;"><span>            custom_tokens <span style="color:#f92672">=</span> remove_noise(word_tokenize(text))
</span></span><span style="display:flex;"><span>            temp_dict <span style="color:#f92672">=</span> dict([token, <span style="color:#66d9ef">True</span>] <span style="color:#66d9ef">for</span> token <span style="color:#f92672">in</span> custom_tokens)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># classify reply</span>
</span></span><span style="display:flex;"><span>            sentiment <span style="color:#f92672">=</span> classifier<span style="color:#f92672">.</span>classify(temp_dict)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> sentiment <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Negative&#39;</span>:
</span></span><span style="display:flex;"><span>                neg <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                temp_user<span style="color:#f92672">.</span>add_neg()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> sentiment <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Positive&#39;</span>:
</span></span><span style="display:flex;"><span>                pos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                temp_user<span style="color:#f92672">.</span>add_pos()
</span></span><span style="display:flex;"><span>            total <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            current_userStore<span style="color:#f92672">.</span>add_user(temp_user)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        posl<span style="color:#f92672">.</span>append(pos)
</span></span><span style="display:flex;"><span>        totl<span style="color:#f92672">.</span>append(total)
</span></span><span style="display:flex;"><span>        negl<span style="color:#f92672">.</span>append(neg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df2 <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>    df2[<span style="color:#e6db74">&#39;id&#39;</span>] <span style="color:#f92672">=</span> corpus_df[<span style="color:#e6db74">&#39;id&#39;</span>]
</span></span><span style="display:flex;"><span>    df2[<span style="color:#e6db74">&#39;positive&#39;</span>] <span style="color:#f92672">=</span> posl
</span></span><span style="display:flex;"><span>    df2[<span style="color:#e6db74">&#39;negative&#39;</span>] <span style="color:#f92672">=</span> negl
</span></span><span style="display:flex;"><span>    df2[<span style="color:#e6db74">&#39;total&#39;</span>] <span style="color:#f92672">=</span> totl
</span></span><span style="display:flex;"><span>    df2<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>full_path<span style="color:#e6db74">}</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">video_feedback_store.csv&#39;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    new_user_store <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(current_userStore<span style="color:#f92672">.</span>flatten())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> index, row <span style="color:#f92672">in</span> new_user_store<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">&#39;accountID&#39;</span>] <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> userStore_df[<span style="color:#e6db74">&#39;accountID&#39;</span>]:
</span></span><span style="display:flex;"><span>            userStore_df<span style="color:#f92672">.</span>loc[len(userStore_df<span style="color:#f92672">.</span>index)] <span style="color:#f92672">=</span> [row[<span style="color:#e6db74">&#39;accountID&#39;</span>], row[<span style="color:#e6db74">&#39;lang&#39;</span>], row[<span style="color:#e6db74">&#39;cumulative_likes&#39;</span>],
</span></span><span style="display:flex;"><span>                                                         row[<span style="color:#e6db74">&#39;pos&#39;</span>], row[<span style="color:#e6db74">&#39;neg&#39;</span>], row[<span style="color:#e6db74">&#39;interactions&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    userStore_df<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>full_path<span style="color:#e6db74">}</span><span style="color:#e6db74">/user_store.csv&#39;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><h4 id="putting-this-all-together">Putting this All Together<a href="#putting-this-all-together" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>Now we can call this is unison as if it&rsquo;s a batch process.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.service.scrape.comments_util <span style="color:#f92672">import</span> TikTokScraper
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> backend.service.model.classifier <span style="color:#f92672">import</span> create_user_store
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:\Users\iannb\PycharmProjects\tiktok_analytics_platform\backend\data&#39;</span>
</span></span><span style="display:flex;"><span>    account <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;washingtonpost&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># scrape videos, comments, and metadata</span>
</span></span><span style="display:flex;"><span>    video_scraper <span style="color:#f92672">=</span> TikTokScraper(account, path)
</span></span><span style="display:flex;"><span>    video_scraper<span style="color:#f92672">.</span>run()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># create the user store</span>
</span></span><span style="display:flex;"><span>    create_user_store(account, path)
</span></span></code></pre></div><h1 id="considerations">Considerations<a href="#considerations" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>We can think of Tweets as a slightly more autonomous medium for expression. A Tweet can have a context, say the Queen dying for example, but it can also be stream of thought and without context, ie. “I hate Jared Leto.” TikTok videos often have a more clear context; comments on any given TikTok are often affirming or disagreeing with the content of the video. Here’s the challenge that comes with using Twitter data: how can we account for affirmation as “positive” sentiment?</p>
<p>Let’s look at an early example I ran into. An early test account I used was the Washington Post. The account at my time of testing had exactly 32 short videos, each with crisp video and audio quality and a reasonable but not overwhelming amount of comments on each. The issue that arose occurred when analyzing Washington Post videos covering news with a negative context, say a thief stealing candy from a baby. A commenter might say, “That guy stinks,” which our sentiment analyzer would yield as negative sentiment. The issue here is that this negative comment actually represents a positive affirmation of the video. 
A couple of options here:
We can analyze the sentiment of the video itself, trying to understand the context of the video in a sense. Let’s look at some features here: the sound in the video, is it audio from OP or a song? What does this say about the video? A viral sound? Is this a trend?</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://ib173.github.io/posts/eventfiltering/">
                <span class="button__icon">←</span>
                <span class="button__text">Lambda Event Filtering for Creating Dynamic SQS Data Persist Pipelines</span>
            </a>
        </span>
        
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://ib173.github.io/assets/main.js"></script>
<script src="https://ib173.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
